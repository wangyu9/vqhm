
pmA1=...
    @(p1,p2,p3)-((p1-1.0).^2+p2.^2)./(p1.^2+p2.^2-1.0);

pmA2=...
    @(p1,p2,p3)(p2.*2.0)./(p1.^2+p2.^2-1.0);

pmA3=...
    @(p1,p2,p3)-((p1+1.0).^2+p2.^2)./(p1.^2+p2.^2-1.0);

ps_dAdP11=...
    @(p1,p2,p3)-(p1.*2.0-2.0)./(p1.^2+p2.^2-1.0)+p1.*((p1-1.0).^2+p2.^2).*1.0./(p1.^2+p2.^2-1.0).^2.*2.0;

ps_dAdP12=...
    @(p1,p2,p3)(p2.*-2.0)./(p1.^2+p2.^2-1.0)+p2.*((p1-1.0).^2+p2.^2).*1.0./(p1.^2+p2.^2-1.0).^2.*2.0;

ps_dAdP13=...
    @(p1,p2,p3)0.0;

ps_dAdP21=...
    @(p1,p2,p3)p1.*p2.*1.0./(p1.^2+p2.^2-1.0).^2.*-4.0;

ps_dAdP22=...
    @(p1,p2,p3)2.0./(p1.^2+p2.^2-1.0)-p2.^2.*1.0./(p1.^2+p2.^2-1.0).^2.*4.0;

ps_dAdP23=...
    @(p1,p2,p3)0.0;

ps_dAdP31=...
    @(p1,p2,p3)-(p1.*2.0+2.0)./(p1.^2+p2.^2-1.0)+p1.*((p1+1.0).^2+p2.^2).*1.0./(p1.^2+p2.^2-1.0).^2.*2.0;

ps_dAdP32=...
    @(p1,p2,p3)(p2.*-2.0)./(p1.^2+p2.^2-1.0)+p2.*((p1+1.0).^2+p2.^2).*1.0./(p1.^2+p2.^2-1.0).^2.*2.0;

ps_dAdP33=...
    @(p1,p2,p3)0.0;

fr1 = @(p1,p2) p1 ./ sqrt(p1.^2+p2.^2) .* ff(sqrt(p1.^2+p2.^2));
fr2 = @(p1,p2) p2 ./ sqrt(p1.^2+p2.^2) .* ff(sqrt(p1.^2+p2.^2));

% let r = sqrt(x^2+y^2)
% ?( r ) / ?x = x/r
% ?( r ) / ?y = y/r
% ?( x/r ) / ?x = (r - x * x/r) / r^2 = (r^2-x^2)/r^3 = y^2/r^3 
% ?( x/r ) / ?y = ( - x * y/r) / r^2 = -x*y/r^3 
% ?( y/r ) / ?x = ( - y * x/r) / r^2 = -x*y/r^3 
% ?( y/r ) / ?y = (r - y * y/r) / r^2 = (r^2-y^2)/r^3 = x^2/r^3 

% let g(r) = f'(r)
% ?( x/r f(r)) / ?x = ( (f+xg)r - xf * x/r) / r^2 = (r^2(f+xg)-x^2f)/r^3 = (y^2f + r^2xg )/r^3 
% or 
% ?( x/r f(r)) / ?x = f (y^2/r^3 ) + g (x/r) * (x/r)
% ?( x/r f(r)) / ?y = f (-x*y/r^3 ) + g (x/r) * (y/r)
% ?( y/r f(r)) / ?x = f (-x*y/r^3 ) + g (y/r) * (x/r)
% ?( y/r f(r)) / ?y = f (x^2/r^3 ) + g (y/r) * (y/r)

 
% @(p1,p2) p2.^2 ./ (sqrt(p1.^2+p2.^2).^3); 
% @(p1,p2) - p1.*p2 ./ (sqrt(p1.^2+p2.^2).^3); 
% @(p1,p2) p1.^2 ./ (sqrt(p1.^2+p2.^2).^3); 



pfr11 = @(p1,p2) ff(sqrt(p1.^2+p2.^2)) .* (p2.^2 ./ (sqrt(p1.^2+p2.^2).^3)) ...
            + gg(sqrt(p1.^2+p2.^2)) .* p1.^2 ./ (p1.^2+p2.^2); 

pfr12 = @(p1,p2) ff(sqrt(p1.^2+p2.^2)) .* (-p1.*p2 ./ (sqrt(p1.^2+p2.^2).^3)) ...
            + gg(sqrt(p1.^2+p2.^2)) .* p1 .* p2 ./ (p1.^2+p2.^2); 

pfr21 = pfr12;
% we do not distinguish 12 and 21, which are same. 
        
pfr22 = @(p1,p2) ff(sqrt(p1.^2+p2.^2)) .* (p1.^2 ./ (sqrt(p1.^2+p2.^2).^3)) ...
            + gg(sqrt(p1.^2+p2.^2)) .* p2.^2 ./ (p1.^2+p2.^2); 
        
mA1=...
    @(p1,p2,p3) pmA1(fr1(p1,p2), fr2(p1,p2), p3);

mA2=...
    @(p1,p2,p3) pmA2(fr1(p1,p2), fr2(p1,p2), p3);

mA3=...
    @(p1,p2,p3) pmA3(fr1(p1,p2), fr2(p1,p2), p3);

np = 3;

s_dAdP1 = cell(1,np);
s_dAdP2 = cell(1,np);
s_dAdP3 = cell(1,np);

% s_dRdP = cell(1,np);
% this is not used anyway. 

s_dAdP1{1}=...
    @(p1,p2,p3) ps_dAdP11(fr1(p1,p2), fr2(p1,p2), p3) .* pfr11(p1,p2) ...
              + ps_dAdP12(fr1(p1,p2), fr2(p1,p2), p3) .* pfr21(p1,p2);
    
s_dAdP1{2}=...
    @(p1,p2,p3) ps_dAdP11(fr1(p1,p2), fr2(p1,p2), p3) .* pfr12(p1,p2) ...
              + ps_dAdP12(fr1(p1,p2), fr2(p1,p2), p3) .* pfr22(p1,p2);
          
s_dAdP1{3}=...
    @(p1,p2,p3) ps_dAdP13(p1,p2,p3);

    
s_dAdP2{1}=...
    @(p1,p2,p3) ps_dAdP21(fr1(p1,p2), fr2(p1,p2), p3) .* pfr11(p1,p2) ...
              + ps_dAdP22(fr1(p1,p2), fr2(p1,p2), p3) .* pfr21(p1,p2);

s_dAdP2{2}=...
    @(p1,p2,p3) ps_dAdP21(fr1(p1,p2), fr2(p1,p2), p3) .* pfr12(p1,p2) ...
              + ps_dAdP22(fr1(p1,p2), fr2(p1,p2), p3) .* pfr22(p1,p2);          
          
s_dAdP2{3}=...
    @(p1,p2,p3) ps_dAdP23(p1,p2,p3);


s_dAdP3{1}=...
    @(p1,p2,p3) ps_dAdP31(fr1(p1,p2), fr2(p1,p2), p3) .* pfr11(p1,p2) ...
              + ps_dAdP32(fr1(p1,p2), fr2(p1,p2), p3) .* pfr21(p1,p2);

s_dAdP3{2}=...
    @(p1,p2,p3) ps_dAdP31(fr1(p1,p2), fr2(p1,p2), p3) .* pfr12(p1,p2) ...
              + ps_dAdP32(fr1(p1,p2), fr2(p1,p2), p3) .* pfr22(p1,p2);          
          
s_dAdP3{3}=...
    @(p1,p2,p3) ps_dAdP33(p1,p2,p3);


nA1=...
    @(p1,p2,p3)-((p1+1.0).^2+p2.^2)./(p1.^2+p2.^2-1.0) + error(['not implemented!']);

nA2=...
    @(p1,p2,p3)(p2.*-2.0)./(p1.^2+p2.^2-1.0);

nA3=...
    @(p1,p2,p3)-((p1-1.0).^2+p2.^2)./(p1.^2+p2.^2-1.0);

t_dAdP11=...
    @(p1,p2,p3)-(p1.*2.0+2.0)./(p1.^2+p2.^2-1.0)+p1.*((p1+1.0).^2+p2.^2).*1.0./(p1.^2+p2.^2-1.0).^2.*2.0;

t_dAdP12=...
    @(p1,p2,p3)(p2.*-2.0)./(p1.^2+p2.^2-1.0)+p2.*((p1+1.0).^2+p2.^2).*1.0./(p1.^2+p2.^2-1.0).^2.*2.0;

t_dAdP13=...
    @(p1,p2,p3)0.0;

t_dAdP21=...
    @(p1,p2,p3)p1.*p2.*1.0./(p1.^2+p2.^2-1.0).^2.*4.0;

t_dAdP22=...
    @(p1,p2,p3)-2.0./(p1.^2+p2.^2-1.0)+p2.^2.*1.0./(p1.^2+p2.^2-1.0).^2.*4.0;

t_dAdP23=...
    @(p1,p2,p3)0.0;

t_dAdP31=...
    @(p1,p2,p3)-(p1.*2.0-2.0)./(p1.^2+p2.^2-1.0)+p1.*((p1-1.0).^2+p2.^2).*1.0./(p1.^2+p2.^2-1.0).^2.*2.0;

t_dAdP32=...
    @(p1,p2,p3)(p2.*-2.0)./(p1.^2+p2.^2-1.0)+p2.*((p1-1.0).^2+p2.^2).*1.0./(p1.^2+p2.^2-1.0).^2.*2.0;

t_dAdP33=...
    @(p1,p2,p3)0.0;